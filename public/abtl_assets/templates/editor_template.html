<div id="abtl-control" data-website="1">
    <!--main controls-->
    <div class="abtl-menu">
        <div class="row abtl-row abtl-menu-bar">
            <div class="col-md-10">
                <ul class="nav nav-tabs" id="abtl-nav-tabs">
                    <li id="abtl-test-nav-template" class="abtl-hidden abtl-tab-label">
                        <a class="abtl-pick-test">New test</a>
                        <input type="text" value="New test" style="display: none" class="test-title form-control" maxlength="30">
                        <span class="abtl-delete-tab">x</span>
                    </li>
                    <li id="abtl-add-new-test"><a>+ Add new</a></li>
                </ul>
            </div>
            <div class="col-md-2 text-right">
                <button id="abtl-save" class="btn btn-default btn-sm">Save</button>
                <button id="abtl-publish" class="btn btn-primary btn-sm">Publish</button>
                <button id="abtl-exit" class="btn btn-danger btn-sm">Exit</button>
            </div>
        </div>
        <div class="abtl-menu-border"></div>
    </div>
    <div class="abtl-container">
        <div class=" abtl-row container-fluid tab-content" id="abtl-tests-container">
            <div class="abtl-test-tab tab-pane abtl-hidden" id="abtl-test-template" data-id="{backend id}">
                <div class="row abtl-tests-window">
                    <div class="abtl-before col-xs-6 abtl-cell" ondrop="drop(event, this)" ondragover="allowDrop(event)">
                        <div class="abtl-instructions">
                            <p>
                            <button class="pull-left abtl-pick-element btn btn-default btn-sm">Pick</button>
                            <strong>Pick</strong> the element you want to optimize
                            or just <strong>drag and drop</strong> it here.
                            </p>
                        </div>

                        <textarea class="abtl-identifier form-control" readonly></textarea>

                        <div class="abtl-image-container">
                             <img class="abtl-identifier-image img-responsive center-block">
                        </div>
                    </div>

                    <div class="abtl-after col-xs-6 abtl-cell">
                        <div class="abtl-instructions">
                            <p>
                            Your changes go <strong>here</strong>.
                            <button class="btn btn-default btn-sm abtl-cutom-style-button pull-right">Style</button>
                            </p>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <textarea class="abtl-test-text form-control" disabled></textarea>
                                
                                <!-- style container -->
                                <div class="custom-style-container" style="display: none">
                                    <div class="container-form">
                                        <div>
                                            <label>Classes</label>
                                            <input type="text" class="custom-style-classes form-control" placeholder="Class list" >
                                        </div>                                    
                                        <div>
                                            <label>Custom style rules</label>
                                            <textarea class="custom-style-css form-control" placeholder="Custom css style rules"></textarea>
                                        </div>
                                        <div>
                                            <button class="btn btn-default btn-lg custom-style-close-button">Close</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row abtl-test-image center-block" style="display:none">
                                    <div class="col-xs-8 image-properties">
                                        <div class="row">
                                            <div class="col-xs-5">
                                                <select class="upload-or-url form-control">
                                                    <option value="url">Image url</option>
                                                    <option value="upload">Upload image</option>
                                                </select>
                                            </div>
                                            <div class="col-xs-7">
                                                <input type="text" name="inputUrl" class="abtl-image-url form-control" placeholder="http://">
                                                <input type="file" name="inputImage" class="abtl-image-upload">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-4 abtl-image-container">
                                        <img src="" class="image-upload-preview img-responsive center-block">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="abtl-conversion-picker">

                    <div class="abtl-default-conversion">
                        <label class="abtl-default-conversion-checkbox"><input type="checkbox" checked> use the same element for conversion tracking</label>
                    </div>
                    <div class="abtl-custom-conversion" style="display: none">
                        <button class="btn btn-default btn-sm abtl-custom-conversion-button">Pick element to track conversions.</button>
                        <input type="hidden" class="conversion-input">
                        <span class="picked-not-picked"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    //help
    $('#abtl-save').prop('title', 'Save changes to website and continue editing');
    $('#abtl-publish').prop('title', 'Save and publish changes to website');
    $('#abtl-exit').prop('title', 'Exit editor now');
    $('#abtl-exit').click(function() { window.location = abtlBackUrl; });

    /*************** TEMPLATE FUNCTIONALITY ****************/
    
    $('.abtl-identifier').change(function(){
        if ($(this).val().length > 0)
            $(this).parent().find('.abtl-pick-element').text('Picked. Again?');
        else
            $(this).parent().find('.abtl-pick-element').text('Pick.');
    });
    
    //custom style open
    $('.abtl-cutom-style-button').click(function (e){
        var container = $(this).parent().parent().parent().find('.custom-style-container');
        container.show();
        container.addClass('abtl-container-expanded');
        
        var classes = container.find('.custom-style-classes');
        var style = container.find('.custom-style-css');
        var element = getCurrentElement();
        
        if (classes.val().length === 0)
        {
            classes.val(prepareClassNames(element.data('class')));
        }
        if (style.val().length === 0)
        {
            style.val(prepareCSS(element.data('style')));
        }
    });
    //custom style close
    $('.custom-style-close-button').click(function (e){
        var container = $(this).parent().parent().parent();        
        container.removeClass('abtl-container-expanded');
        container.hide();
        
        var classes = container.find('.custom-style-classes');
        var style = container.find('.custom-style-css');
        var element = getCurrentElement();
        
        if (classes.val() === prepareClassNames(element.data('class')))
        {            
            classes.val('');
        }
        if (style.val() === prepareCSS(element.data('style')))
        {
            style.val('');
        }
        applyActiveTest();
    });
    
    //image url changes
    $('.abtl-image-url').change(function(e){
        toField().val($(this).val());
        $(this).parent().parent().parent().parent().parent().find('.image-upload-preview').attr('src', $(this).val());
    });
    
    //initial or new size
    $('.initial-or-new-size').change(function(e) {
        var width = $(this).parent().parent().find('.imageWidth');
        var height = $(this).parent().parent().find('.imageHeight');
        if ($(this).val() === 'new')
        {
            $(this).data('initial_height', height.val());
            $(this).data('initial_width', width.val());
            
            //not set, gotta read from image preview
            if (!$(this).data('new_height'))
            {
                var imagePreview = $(this).parent().parent().parent().parent().parent().find('.image-upload-preview');
                $(this).data('new_height', imagePreview.prop('naturalHeight'));
                $(this).data('new_width', imagePreview.prop('naturalWidth'));
            }
            height.val($(this).data('new_height'));
            width.val($(this).data('new_width'));
        }
        else
        {
            $(this).data('new_height', height.val());
            $(this).data('new_width', width.val());
            
            height.val($(this).data('initial_height'));
            width.val($(this).data('initial_width'));
        }
    
    });
    //upload or url
    $('.upload-or-url').change(function (e) {
        if ($(this).val() === 'url')
        {
            $(this).parent().parent().find('.abtl-image-url').show();
            $(this).parent().parent().find('.abtl-image-upload').hide();
        } else
        {
            $(this).parent().parent().find('.abtl-image-url').hide();
            $(this).parent().parent().find('.abtl-image-upload').show();
        }
    });
    //initial
    $('.upload-or-url').change();

    $('.abtl-test-text').keyup(function(e) {
        applyActiveTest();
    });

    $('.abtl-default-conversion-checkbox input').change(function (e) {
        if ($(this).is(':checked'))
        {
            $(this).parent().parent().parent().find('.conversion-input').val('');
            resetConversions();

            $(this).parent().parent().parent().find('.abtl-custom-conversion').hide();
            $('.abtl-test-tab.active .abtl-tests-window').removeClass('abtl-tests-window-smaller');
        } else
        {
            $(this).parent().parent().parent().find('.abtl-custom-conversion').show();
            $('.abtl-test-tab.active .abtl-tests-window').addClass("abtl-tests-window-smaller");
        }
    });

    //save renamed test
    $('.test-title').blur(function() {
        link = $(this).parent().find('.abtl-pick-test');
        link.text($(this).val());
        link.show();
        $(this).hide();
    });
    $('.test-title').keypress(function(e){
        if(e.which === 13)
        {
            $(this).blur();
        }
    });

    $(".abtl-custom-conversion-button").click(function (ev) {pickConversionElement($(this), ev);});

    $(".abtl-pick-element").click(function (ev) { pickTestElement($(this), ev); });

    $("#abtl-add-new-test").click(function (ev) {
        addTest();
        //show title input, encourage user to rename test
        $(".abtl-tab-label.active .abtl-pick-test").click();
        $(".abtl-tab-label.active .test-title").focus();
        $(".abtl-tab-label.active .test-title").select();
    });

    $(".abtl-tab-label .abtl-pick-test").click(function (ev) { chooseTest($(this)); });

    $('.abtl-delete-tab').click (function (ev) { deleteTest($(this)); });

    $('.abtl-image-container').click ( function () {
        $(this).toggleClass('abtl-container-expanded');

    } );

    $(".abtl-image-upload").change(function(){
        previewImageUpload($(this));
    });

    $('#abtl-save').click(function () {
        saveTests();
    });

    $('#abtl-publish').click(function () {
        publishTests();
    });

   loadTests();
</script>